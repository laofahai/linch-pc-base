name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - 'ubuntu'
          - 'windows'
          - 'macos-arm'
          - 'macos-x64'

env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            rust_target: 'aarch64-apple-darwin'
            label: 'macos-arm'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            rust_target: 'x86_64-apple-darwin'
            label: 'macos-x64'
          - platform: 'ubuntu-22.04'
            args: ''
            rust_target: ''
            label: 'ubuntu'
          - platform: 'windows-latest'
            args: ''
            rust_target: ''
            label: 'windows'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Check if should run
        id: should_run
        shell: bash
        run: |
          INPUT_PLATFORM="${{ github.event.inputs.platform }}"
          MATRIX_LABEL="${{ matrix.label }}"
          if [ -n "$INPUT_PLATFORM" ] && [ "$INPUT_PLATFORM" != "$MATRIX_LABEL" ]; then
            echo "Skipping $MATRIX_LABEL (requested: $INPUT_PLATFORM)"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Building $MATRIX_LABEL"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.should_run.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: steps.should_run.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Setup pnpm
        if: steps.should_run.outputs.skip != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Rust stable
        if: steps.should_run.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target
        if: steps.should_run.outputs.skip != 'true' && matrix.rust_target != ''
        run: rustup target add ${{ matrix.rust_target }}

      - name: Install dependencies (Ubuntu)
        if: steps.should_run.outputs.skip != 'true' && matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        if: steps.should_run.outputs.skip != 'true'
        run: pnpm install

      - name: Replace config placeholders
        if: steps.should_run.outputs.skip != 'true'
        run: |
          node -e "
            const fs = require('fs');
            const path = 'src-tauri/tauri.conf.json';
            let content = fs.readFileSync(path, 'utf8');
            content = content.replace(/\{\{OSS_BUCKET\}\}/g, '${{ vars.OSS_BUCKET }}');
            content = content.replace(/\{\{OSS_REGION\}\}/g, '${{ vars.OSS_REGION }}');
            content = content.replace(/\{\{GITHUB_REPOSITORY\}\}/g, '${{ github.repository }}');
            fs.writeFileSync(path, content);
            console.log('Updated tauri.conf.json');
            const parsed = JSON.parse(content);
            console.log('Endpoints:', JSON.stringify(parsed.plugins.updater.endpoints, null, 2));
          "

      - name: Build Tauri app
        if: steps.should_run.outputs.skip != 'true'
        id: tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'v__VERSION__'
          releaseBody: 'See the assets to download and install this version.'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      - name: List build artifacts
        if: steps.should_run.outputs.skip != 'true'
        run: |
          echo "=== Build artifacts ==="
          find src-tauri/target -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" \) 2>/dev/null || true
        shell: bash

      - name: Upload artifacts for OSS sync
        if: steps.should_run.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.label }}
          path: |
            src-tauri/target/**/release/bundle/**/*.msi
            src-tauri/target/**/release/bundle/**/*.exe
            src-tauri/target/**/release/bundle/**/*.dmg
            src-tauri/target/**/release/bundle/**/*.app.tar.gz
            src-tauri/target/**/release/bundle/**/*.AppImage
            src-tauri/target/**/release/bundle/**/*.deb
            src-tauri/target/**/release/bundle/**/*.sig
          if-no-files-found: ignore

  # Sync to Aliyun OSS
  sync-oss:
    needs: release
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_OSS_SYNC == 'true' && github.event.inputs.platform == '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f | sort

      - name: Setup aliyun ossutil
        run: |
          curl -o ossutil.zip https://gosspublic.alicdn.com/ossutil/1.7.18/ossutil-v1.7.18-linux-amd64.zip
          unzip ossutil.zip
          chmod +x ossutil-v1.7.18-linux-amd64/ossutil64
          sudo mv ossutil-v1.7.18-linux-amd64/ossutil64 /usr/local/bin/ossutil
          ossutil config -e oss-${{ vars.OSS_REGION }}.aliyuncs.com -i ${{ secrets.OSS_ACCESS_KEY_ID }} -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Sync artifacts to OSS
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BUCKET=${{ vars.OSS_BUCKET }}

          echo "Uploading to oss://${BUCKET}/releases/${VERSION}/"

          # Upload all artifacts
          find artifacts -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.sig" \) | while read file; do
            filename=$(basename "$file")
            echo "Uploading $filename..."
            ossutil cp "$file" "oss://${BUCKET}/releases/${VERSION}/${filename}" -f
          done

      - name: Generate and upload latest.json
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BUCKET=${{ vars.OSS_BUCKET }}
          REGION=${{ vars.OSS_REGION }}
          BASE_URL="https://${BUCKET}.oss-${REGION}.aliyuncs.com/releases/${VERSION}"

          echo "=== Generating latest.json ==="

          # Create base JSON
          jq -n \
            --arg version "$VERSION" \
            --arg notes "Release $VERSION" \
            --arg pub_date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: {}}' > latest.json

          # Function to add platform
          add_platform() {
            local platform=$1
            local pattern=$2
            local file=$(find artifacts -type f -name "$pattern" 2>/dev/null | head -1)

            if [ -n "$file" ] && [ -f "$file" ]; then
              local filename=$(basename "$file")
              local sig_file="${file}.sig"
              local sig_content=""

              if [ -f "$sig_file" ]; then
                sig_content=$(cat "$sig_file")
                echo "✓ Found signature for $filename"
              else
                echo "⚠ No signature file for $filename"
              fi

              echo "Adding platform $platform: $filename"
              jq --arg platform "$platform" \
                 --arg url "${BASE_URL}/${filename}" \
                 --arg sig "$sig_content" \
                 '.platforms[$platform] = {url: $url, signature: $sig}' latest.json > tmp.json && mv tmp.json latest.json
            else
              echo "✗ No file found for platform $platform (pattern: $pattern)"
            fi
          }

          # Add platforms - use wildcards for Tauri naming conventions
          add_platform "windows-x86_64" "*.msi"
          add_platform "darwin-aarch64" "*aarch64*.app.tar.gz"
          add_platform "darwin-x86_64" "*x86_64*.app.tar.gz"
          add_platform "linux-x86_64" "*.AppImage"

          echo ""
          echo "=== Generated latest.json ==="
          cat latest.json

          # Upload latest.json
          ossutil cp latest.json "oss://${BUCKET}/releases/latest.json" -f

      - name: Verify OSS upload
        run: |
          BUCKET=${{ vars.OSS_BUCKET }}
          VERSION=${{ steps.version.outputs.VERSION }}
          echo "=== Files in OSS ==="
          ossutil ls "oss://${BUCKET}/releases/${VERSION}/" --limited-num 50
          echo ""
          echo "=== latest.json content ==="
          ossutil cat "oss://${BUCKET}/releases/latest.json" || echo "Failed to read latest.json"
